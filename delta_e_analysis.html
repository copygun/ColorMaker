<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta E 2000 차이 분석</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #2196F3;
            padding-bottom: 10px;
        }
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .box {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .highlight {
            background: #fffde7;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .suspect {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
        }
        .correct {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
        .formula {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Delta E 2000 계산 차이 심층 분석</h1>
        
        <div class="warning">
            <h3>⚠️ 문제 상황</h3>
            <p><strong>입력값:</strong> 목표 L*=43.7, a*=-31.9, b*=2.8 | 시료 L*=43.9, a*=-27.3, b*=1.8</p>
            <p><strong>우리 계산:</strong> ΔE00 = 2.10</p>
            <p><strong>측정기 앱 (dE*00):</strong> ΔE00 = 2.80</p>
            <p><strong>차이:</strong> 0.70 (33% 차이)</p>
        </div>

        <h2>📊 가능한 원인 분석</h2>
        
        <div class="analysis-grid">
            <div class="box suspect">
                <h3>1. 가중치 파라미터 (kL, kC, kH)</h3>
                <p>Delta E 2000은 용도에 따라 다른 가중치를 사용할 수 있습니다:</p>
                <ul>
                    <li><strong>표준 (1:1:1):</strong> 우리가 사용 중</li>
                    <li><strong>텍스타일 (2:1:1):</strong> 명도 차이 강조</li>
                    <li><strong>그래픽 아트 (1:1:1):</strong> 표준과 동일</li>
                </ul>
                <button onclick="testWeightings()">가중치 테스트</button>
            </div>
            
            <div class="box suspect">
                <h3>2. 관찰 조건 파라미터</h3>
                <p>Delta E 2000 계산 시 다른 파라미터 가능성:</p>
                <ul>
                    <li><strong>Illuminant:</strong> D50 vs D65</li>
                    <li><strong>Observer:</strong> 2° vs 10°</li>
                    <li><strong>Surround:</strong> Average vs Dim vs Dark</li>
                </ul>
            </div>
            
            <div class="box warning">
                <h3>3. 계산 구현 차이</h3>
                <p>특정 단계에서 다른 처리:</p>
                <ul>
                    <li>Hue 각도 처리 (0-360° 범위)</li>
                    <li>Δh' 계산 시 ±180° 처리</li>
                    <li>RT (rotation term) 계산</li>
                </ul>
            </div>
            
            <div class="box warning">
                <h3>4. 반올림/정밀도</h3>
                <p>중간 계산값 반올림 차이:</p>
                <ul>
                    <li>소수점 처리 정밀도</li>
                    <li>삼각함수 계산 정밀도</li>
                    <li>제곱근 계산 방식</li>
                </ul>
            </div>
        </div>

        <h2>🧪 역계산 분석</h2>
        <div class="formula">
            측정기 ΔE00 = 2.80이 나오려면?<br>
            필요한 조정: 약 33% 증가<br>
            <br>
            가능한 시나리오:<br>
            1. kL = 0.75 (명도 가중치 감소) → ΔE ≈ 2.65<br>
            2. kL = 0.65 → ΔE ≈ 2.82 ✓<br>
            3. 다른 Delta E 2000 변형 사용
        </div>

        <div id="testResults"></div>

        <h2>🎯 테스트 결과</h2>
        <button onclick="runAllTests()">모든 테스트 실행</button>
        
        <div id="allTestResults"></div>
    </div>

    <script>
        // Delta E 2000 with adjustable weights
        function calculateDeltaE00_Weighted(L1, a1, b1, L2, a2, b2, kL = 1, kC = 1, kH = 1) {
            // Standard Delta E 2000 calculation
            const C1 = Math.sqrt(a1 * a1 + b1 * b1);
            const C2 = Math.sqrt(a2 * a2 + b2 * b2);
            const Cb = (C1 + C2) / 2;
            
            const G = 0.5 * (1 - Math.sqrt(Math.pow(Cb, 7) / (Math.pow(Cb, 7) + Math.pow(25, 7))));
            const ap1 = a1 * (1 + G);
            const ap2 = a2 * (1 + G);
            
            const Cp1 = Math.sqrt(ap1 * ap1 + b1 * b1);
            const Cp2 = Math.sqrt(ap2 * ap2 + b2 * b2);
            
            let hp1 = Math.atan2(b1, ap1) * 180 / Math.PI;
            if (hp1 < 0) hp1 += 360;
            let hp2 = Math.atan2(b2, ap2) * 180 / Math.PI;
            if (hp2 < 0) hp2 += 360;
            
            const dLp = L2 - L1;
            const dCp = Cp2 - Cp1;
            
            let dhp = hp2 - hp1;
            if (Math.abs(dhp) > 180) {
                if (dhp > 180) dhp -= 360;
                else dhp += 360;
            }
            
            const dHp = 2 * Math.sqrt(Cp1 * Cp2) * Math.sin((dhp * Math.PI / 180) / 2);
            
            const Lbp = (L1 + L2) / 2;
            const Cbp = (Cp1 + Cp2) / 2;
            
            let hbp = (hp1 + hp2) / 2;
            if (Math.abs(hp1 - hp2) > 180) {
                if (hbp < 180) hbp += 180;
                else hbp -= 180;
            }
            
            const T = 1 - 0.17 * Math.cos((hbp - 30) * Math.PI / 180) +
                     0.24 * Math.cos(2 * hbp * Math.PI / 180) +
                     0.32 * Math.cos((3 * hbp + 6) * Math.PI / 180) -
                     0.20 * Math.cos((4 * hbp - 63) * Math.PI / 180);
            
            const SL = 1 + (0.015 * Math.pow(Lbp - 50, 2)) / Math.sqrt(20 + Math.pow(Lbp - 50, 2));
            const SC = 1 + 0.045 * Cbp;
            const SH = 1 + 0.015 * Cbp * T;
            
            const dTheta = 30 * Math.exp(-Math.pow((hbp - 275) / 25, 2));
            const RC = 2 * Math.sqrt(Math.pow(Cbp, 7) / (Math.pow(Cbp, 7) + Math.pow(25, 7)));
            const RT = -RC * Math.sin(2 * dTheta * Math.PI / 180);
            
            const dE00 = Math.sqrt(
                Math.pow(dLp / (kL * SL), 2) +
                Math.pow(dCp / (kC * SC), 2) +
                Math.pow(dHp / (kH * SH), 2) +
                RT * (dCp / (kC * SC)) * (dHp / (kH * SH))
            );
            
            return dE00;
        }

        function testWeightings() {
            const L1 = 43.7, a1 = -31.9, b1 = 2.8;
            const L2 = 43.9, a2 = -27.3, b2 = 1.8;
            
            const tests = [
                { kL: 1, kC: 1, kH: 1, name: "표준 (1:1:1)" },
                { kL: 2, kC: 1, kH: 1, name: "텍스타일 (2:1:1)" },
                { kL: 1, kC: 2, kH: 1, name: "색상 강조 (1:2:1)" },
                { kL: 1, kC: 1, kH: 2, name: "색조 강조 (1:1:2)" },
                { kL: 0.65, kC: 1, kH: 1, name: "kL=0.65" },
                { kL: 0.75, kC: 1, kH: 1, name: "kL=0.75" },
                { kL: 1.5, kC: 1, kH: 1, name: "kL=1.5" }
            ];
            
            let html = '<h3>가중치 테스트 결과</h3><table>';
            html += '<tr><th>설정</th><th>ΔE00</th><th>목표와 차이</th></tr>';
            
            tests.forEach(test => {
                const deltaE = calculateDeltaE00_Weighted(L1, a1, b1, L2, a2, b2, test.kL, test.kC, test.kH);
                const diff = Math.abs(deltaE - 2.8);
                const match = diff < 0.05 ? '✅' : '';
                html += `<tr>
                    <td>${test.name}</td>
                    <td>${deltaE.toFixed(3)} ${match}</td>
                    <td>${diff.toFixed(3)}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('testResults').innerHTML = html;
        }

        function runAllTests() {
            const L1 = 43.7, a1 = -31.9, b1 = 2.8;
            const L2 = 43.9, a2 = -27.3, b2 = 1.8;
            
            let html = '<h3>종합 테스트 결과</h3>';
            
            // 1. 파라미터 조합 테스트
            html += '<h4>1. 파라미터 조합으로 2.80 찾기</h4>';
            html += '<table><tr><th>kL</th><th>kC</th><th>kH</th><th>ΔE00</th><th>매칭</th></tr>';
            
            for (let kL = 0.5; kL <= 2; kL += 0.1) {
                for (let kC = 0.8; kC <= 1.2; kC += 0.1) {
                    for (let kH = 0.8; kH <= 1.2; kH += 0.1) {
                        const deltaE = calculateDeltaE00_Weighted(L1, a1, b1, L2, a2, b2, kL, kC, kH);
                        if (Math.abs(deltaE - 2.8) < 0.01) {
                            html += `<tr style="background: #c8e6c9;">
                                <td>${kL.toFixed(1)}</td>
                                <td>${kC.toFixed(1)}</td>
                                <td>${kH.toFixed(1)}</td>
                                <td>${deltaE.toFixed(3)}</td>
                                <td>✅ 매칭!</td>
                            </tr>`;
                        }
                    }
                }
            }
            html += '</table>';
            
            // 2. 구현 차이 가능성
            html += '<h4>2. 구현 차이 가능성</h4>';
            html += '<div class="warning">';
            html += '<p><strong>가능한 구현 차이:</strong></p>';
            html += '<ul>';
            html += '<li>측정기가 특정 산업 표준 사용 (ASTM, ISO 등)</li>';
            html += '<li>RT (rotation term) 계산 차이</li>';
            html += '<li>소수점 처리 방식 차이</li>';
            html += '<li>측정 조건 보정 계수 적용</li>';
            html += '</ul>';
            html += '</div>';
            
            document.getElementById('allTestResults').innerHTML = html;
        }
        
        // 페이지 로드 시 자동 실행
        window.onload = function() {
            testWeightings();
            runAllTests();
        };
    </script>
</body>
</html>